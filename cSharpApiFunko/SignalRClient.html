<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>💖 Cliente SignalR para FunkoStore 💖</title>
  <link href="https://fonts.googleapis.com/css2?family=Knewave&family=Balsamiq+Sans&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
  <style>
    /* --- ESTILOS ORIGINALES MANTENIDOS --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --hk-pink: #FF69B4;
      --hk-light-pink: #FFB6C1;
      --hk-red: #FF1493;
      --hk-yellow: #FFD700;
      --hk-purple: #9370DB;
      --hk-blue: #87CEEB;
      --hk-green: #98FB98;
    }

    body {
      background: linear-gradient(135deg, #FFB6C1, #FFC0CB, #FFE4E1, #FFF0F5);
      background-size: 400% 400%;
      animation: gradientShift 8s ease infinite;
      font-family: 'Balsamiq Sans', cursive, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
      50% { opacity: 0.7; transform: scale(1.2) rotate(180deg); }
    }

    .floating-ribbon {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 2em;
      animation: float 3s ease-in-out infinite;
      z-index: 1000;
    }

    .container {
      background: linear-gradient(180deg, #FFFFFF 0%, #FFF5F8 100%);
      border: 5px solid var(--hk-pink);
      border-radius: 30px;
      padding: 30px;
      width: 95%;
      max-width: 1000px;
      margin: 0 auto;
      box-shadow:
              0 20px 60px rgba(255, 105, 180, 0.4),
              0 0 0 10px var(--hk-light-pink),
              inset 0 0 60px rgba(255, 182, 193, 0.3);
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '🎀';
      position: absolute;
      top: -15px;
      left: 30px;
      font-size: 3em;
      animation: float 2s ease-in-out infinite;
    }

    .container::after {
      content: '🎀';
      position: absolute;
      top: -15px;
      right: 30px;
      font-size: 3em;
      animation: float 2s ease-in-out infinite 1s;
    }

    h1 {
      color: var(--hk-pink);
      text-align: center;
      font-family: 'Knewave', cursive;
      font-size: 2.5em;
      text-shadow: 3px 3px var(--hk-light-pink);
      margin-bottom: 25px;
      position: relative;
    }

    h1::before, h1::after {
      content: '✨';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      animation: sparkle 2s ease-in-out infinite;
    }

    h1::before { left: 20px; }
    h1::after { right: 20px; animation-delay: 1s; }

    /* Login Section */
    .login-section {
      background: linear-gradient(135deg, #FFE4EC 0%, #FFF0F5 50%, #FFE4EC 100%);
      border: 4px solid var(--hk-pink);
      border-radius: 25px;
      padding: 25px;
      margin-bottom: 25px;
      position: relative;
    }

    .login-section::before {
      content: '🔐';
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2.5em;
      background: white;
      padding: 5px 15px;
      border-radius: 50%;
      border: 3px solid var(--hk-pink);
    }

    .login-title {
      color: var(--hk-red);
      text-align: center;
      font-family: 'Knewave', cursive;
      font-size: 1.5em;
      margin: 15px 0 20px 0;
    }

    .login-form {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: center;
    }

    .input-group {
      position: relative;
      flex: 1;
      min-width: 180px;
      max-width: 250px;
    }

    .input-group label {
      display: block;
      color: var(--hk-red);
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 1em;
    }

    .input-group input {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 3px solid var(--hk-light-pink);
      border-radius: 25px;
      font-size: 1em;
      font-family: 'Balsamiq Sans', cursive;
      transition: all 0.3s ease;
      background: white;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--hk-pink);
      box-shadow: 0 0 20px rgba(255, 105, 180, 0.4);
    }

    .input-icon {
      position: absolute;
      left: 15px;
      top: 38px;
      font-size: 1.2em;
    }

    .btn-login {
      padding: 12px 30px;
      background: linear-gradient(135deg, var(--hk-pink), var(--hk-red));
      color: white;
      border: 3px solid var(--hk-red);
      border-radius: 25px;
      font-family: 'Knewave', cursive;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-login::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }

    .btn-login:hover::before {
      width: 200px;
      height: 200px;
    }

    .btn-login:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 15, 147, 0.5);
    }

    .btn-login:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Demo Users */
    .demo-users {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .demo-user {
      padding: 8px 15px;
      background: linear-gradient(135deg, #E6E6FA, #DDA0DD);
      border: 2px solid var(--hk-purple);
      border-radius: 15px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .demo-user:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(147, 112, 219, 0.4);
    }

    .demo-user .role {
      font-weight: bold;
      color: var(--hk-purple);
    }

    /* Token Display */
    .token-section {
      background: linear-gradient(135deg, #FFF5EE, #FFE4E1);
      border: 4px solid var(--hk-light-pink);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section-title {
      color: var(--hk-pink);
      font-family: 'Knewave', cursive;
      font-size: 1.4em;
      text-align: center;
      margin-bottom: 15px;
      position: relative;
    }

    .section-title::before, .section-title::after {
      content: '🎀';
      font-size: 0.7em;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
    }

    .section-title::before { left: 10px; }
    .section-title::after { right: 10px; }

    .token-display {
      background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
      border: 3px solid var(--hk-purple);
      border-radius: 15px;
      padding: 15px;
      margin-top: 10px;
    }

    .token-display label {
      color: var(--hk-purple);
      font-weight: bold;
    }

    .token-display input {
      background: transparent !important;
      border: none !important;
      color: #00ff00;
      font-family: 'Balsamiq Sans', cursive;
      font-size: 0.85em;
      padding: 0 !important;
      margin-top: 5px;
      width: 100%;
    }

    .token-display input:focus {
      box-shadow: none !important;
      outline: none;
    }

    /* Hub Section */
    .hub-section {
      background: linear-gradient(135deg, #E0FFFF, #87CEEB);
      border: 4px solid #4682B4;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .hub-section .section-title {
      color: #191970;
    }

    .hub-form {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .hub-group {
      flex: 1;
      min-width: 300px;
    }

    .hub-group label {
      display: block;
      color: #4682B4;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .hub-group input {
      width: 100%;
      padding: 12px 15px;
      border: 3px solid #87CEEB;
      border-radius: 25px;
      font-size: 1em;
      font-family: 'Balsamiq Sans', cursive;
      transition: all 0.3s ease;
      background: white;
    }

    .hub-group input:focus {
      outline: none;
      border-color: #4682B4;
      box-shadow: 0 0 20px rgba(70, 130, 180, 0.4);
    }

    .btn-connect {
      padding: 12px 30px;
      background: linear-gradient(135deg, var(--hk-green), #32CD32);
      color: #006400;
      border: 3px solid #228B22;
      border-radius: 25px;
      font-family: 'Knewave', cursive;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-connect:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(50, 205, 50, 0.5);
    }

    .btn-connect:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-disconnect {
      padding: 12px 30px;
      background: linear-gradient(135deg, #FFB6C1, #FF69B4);
      color: var(--hk-red);
      border: 3px solid var(--hk-red);
      border-radius: 25px;
      font-family: 'Knewave', cursive;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-disconnect:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 105, 180, 0.5);
    }

    /* Subscriptions */
    .subs-section {
      background: linear-gradient(135deg, #F0FFF0, #F5FFFA);
      border: 4px solid var(--hk-green);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .subs-section .section-title {
      color: #006400;
    }

    .subs-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }

    .sub-item {
      padding: 10px 15px;
      background: linear-gradient(135deg, var(--hk-green), #90EE90);
      border: 3px solid #228B22;
      border-radius: 15px;
      font-family: 'Balsamiq Sans', cursive;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sub-item.active {
      background: linear-gradient(135deg, #FFB347, #FF8C00);
      border-color: #FF8C00;
    }

    /* Received Messages */
    .received-section {
      background: linear-gradient(135deg, #FFF8DC, #FAF0E6);
      border: 4px dashed var(--hk-yellow);
      border-radius: 20px;
      padding: 20px;
    }

    #receivedMessages {
      background: #1e1e1e;
      border: 3px solid #333;
      border-radius: 15px;
      padding: 20px;
      color: #00ff00;
      font-family: 'Balsamiq Sans', cursive;
      font-size: 0.85em;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Status */
    .status-bar {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .status-item {
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-connected {
      background: linear-gradient(135deg, var(--hk-green), #90EE90);
      color: #006400;
      border: 3px solid #228B22;
    }

    .status-disconnected {
      background: linear-gradient(135deg, #FFB6C1, #FF69B4);
      color: var(--hk-red);
      border: 3px solid var(--hk-red);
    }

    .status-loading {
      background: linear-gradient(135deg, var(--hk-yellow), #FFA500);
      color: #8B4513;
      border: 3px solid #DAA520;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Info Box */
    .info-box {
      background: linear-gradient(135deg, #E0FFFF, #87CEEB);
      border: 4px solid #4682B4;
      border-radius: 15px;
      padding: 15px;
      margin-top: 20px;
      font-size: 0.9em;
    }

    .info-box h4 {
      color: #191970;
      margin-bottom: 10px;
    }

    .info-box code {
      background: rgba(255,255,255,0.5);
      padding: 2px 8px;
      border-radius: 5px;
    }

    /* Scrollbar */
    #receivedMessages::-webkit-scrollbar {
      width: 12px;
    }

    #receivedMessages::-webkit-scrollbar-track {
      background: #333;
      border-radius: 10px;
    }

    #receivedMessages::-webkit-scrollbar-thumb {
      background: var(--hk-pink);
      border-radius: 10px;
    }

    @media (max-width: 768px) {
      .login-form, .hub-form {
        flex-direction: column;
        align-items: stretch;
      }

      .input-group, .hub-group {
        max-width: 100%;
      }

      .btn-login, .btn-connect, .btn-disconnect {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="floating-ribbon">🎀</div>

<div class="container">
  <h1>💖 Cliente SignalR para FunkoStore 💖</h1>

  <div class="status-bar">
    <div id="authStatus" class="status-item status-disconnected">
      🔓 Sin autenticación
    </div>
    <div id="signalrStatus" class="status-item status-disconnected">
      📡 SignalR desconectado
    </div>
  </div>

  <div class="login-section">
    <h2 class="login-title">🔐 Login para obtener Token</h2>
    <div class="login-form">
      <div class="input-group">
        <label for="email">📧 Email</label>
        <span class="input-icon">📧</span>
        <input type="email" id="email" placeholder="tu@email.com" value="admin@tienda.com">
      </div>
      <div class="input-group">
        <label for="password">🔑 Password</label>
        <span class="input-icon">🔑</span>
        <input type="password" id="password" placeholder="Contraseña" value="admin">
      </div>
      <button id="btnLogin" class="btn-login" onclick="doLogin()">
        🎀 Login
      </button>
    </div>
    <div class="demo-users">
      <div class="demo-user" onclick="fillDemo('admin@tienda.com', 'admin')">
        👑 Admin<br><span class="role">ADMIN</span>
      </div>
      <div class="demo-user" onclick="fillDemo('userdaw@tienda.com', 'userdaw')">
        👤 User<br><span class="role">USER</span>
      </div>
    </div>
  </div>

  <div class="token-section">
    <h3 class="section-title">🔐 Token JWT (usado en accessTokenFactory)</h3>
    <div class="token-display">
      <label for="token">Tu Token:</label>
      <input type="text" id="token" placeholder="Pega tu token aquí o usa el login arriba">
    </div>
  </div>

  <div class="hub-section">
    <h3 class="section-title">🔗 Conectar a Hub SignalR</h3>
    <div class="hub-form">
      <div class="hub-group">
        <label for="hubUrl">📡 Hub URL (Correcto: /hubs/funkos):</label>
        <input type="text" id="hubUrl" placeholder="http://localhost:5180/hubs/funkos">
      </div>
      <button id="btnConnect" class="btn-connect" onclick="connectSignalR()">
        🔌 Conectar
      </button>
      <button id="btnDisconnect" class="btn-disconnect" onclick="disconnectSignalR()" disabled>
        💔 Desconectar
      </button>
    </div>
    <div class="subs-list">
      <div class="sub-item" id="subNuevoFunko">
        ✨ OnNuevoFunko
      </div>
      <div class="sub-item" id="subFunkoActualizado">
        🔄 OnFunkoActualizado
      </div>
      <div class="sub-item" id="subFunkoPatch">
        🩹 OnFunkoPatch
      </div>
      <div class="sub-item" id="subFunkoEliminado">
        ❌ OnFunkoEliminado
      </div>
    </div>
  </div>

  <div class="received-section">
    <h3 class="section-title">📨 Notificaciones Recibidas</h3>
    <div id="receivedMessages">💖 Esperando notificaciones de SignalR... ✨

      Conecta a un Hub y espera a que el servidor envíe eventos en tiempo real.</div>
  </div>

  <div class="info-box">
    <h4>💡 Información</h4>
    <p>• <b>Hubs disponibles:</b> <code>/hubs/funkos</code></p>
    <p>• <b>Grupo Admin:</b> Este cliente se une automáticamente al grupo "admins" al conectar.</p>
    <p>• <b>Eventos:</b> NuevoFunko, FunkoActualizado, FunkoActualizadoPatch, FunkoEliminado</p>
  </div>
</div>

<script>
  const API_URL = 'http://localhost:5180';

  let connection = null;
  let reconnectAttempts = 0;
  const maxReconnectAttempts = 3;

  function fillDemo(email, password) {
    document.getElementById('email').value = email;
    document.getElementById('password').value = password;
  }

  // LOGICA DE LOGIN (Se mantiene por si en el futuro añades Auth)
  async function doLogin() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const btn = document.getElementById('btnLogin');
    const status = document.getElementById('authStatus');

    if (!email || !password) {
      alert('📧 Completa email y contraseña 💕');
      return;
    }

    btn.disabled = true;
    btn.textContent = '⏳...';
    status.className = 'status-item status-loading';
    status.textContent = '🔄 Autenticando...';

    try {
      const response = await fetch(`${API_URL}/api/v1/auth/signin`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await response.json();

      if (response.ok && data.token) {
        document.getElementById('token').value = data.token;
        status.className = 'status-item status-connected';
        status.innerHTML = `🔓 ${data.user?.email || email} (${data.user?.role || 'USER'})`;
        addMessage('SISTEMA', '✅ Login exitoso! Token almacenado. Ya puedes conectar a SignalR. 💖', 'success');
      } else {
        status.className = 'status-item status-disconnected';
        status.textContent = '🔓 Error';
        addMessage('SISTEMA', '❌ ' + (data.message || 'Credenciales inválidas'), 'error');
      }
    } catch (error) {
      status.className = 'status-item status-disconnected';
      status.textContent = '🔓 Error';
      // No mostramos error grave si solo es que la API no tiene Auth implementado aún
      addMessage('SISTEMA', '⚠️ No se pudo contactar endpoint de login (¿quizás no está implementado aún?). Puedes intentar conectar a SignalR sin token.', 'info');
    }

    btn.disabled = false;
    btn.textContent = '🎀 Login';
  }

  async function connectSignalR() {
    const hubUrl = document.getElementById('hubUrl').value.trim();
    const token = document.getElementById('token').value.trim();
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const status = document.getElementById('signalrStatus');

    if (!hubUrl) {
      alert('📡 Ingresa una URL de Hub SignalR 💕');
      return;
    }

    try {
      status.className = 'status-item status-loading';
      status.textContent = '🔄 Conectando...';
      btnConnect.disabled = true;

      // Crear conexión SignalR con accessTokenFactory
      connection = new signalR.HubConnectionBuilder()
              .withUrl(hubUrl, {
                // Pasamos el token si existe, si no, se conecta sin auth
                accessTokenFactory: () => token
              })
              .withAutomaticReconnect([0, 1000, 5000, 10000])
              .configureLogging(signalR.LogLevel.Information)
              .build();

      // --- REGISTRO DE EVENTOS (Adaptado a FunkoService.cs) ---

      connection.on('NuevoFunko', (data) => {
        addMessage('✨ NUEVO_FUNKO', JSON.stringify(data, null, 2), 'received');
        markSubActive('subNuevoFunko');
      });

      connection.on('FunkoActualizado', (data) => {
        addMessage('🔄 FUNKO_ACTUALIZADO', JSON.stringify(data, null, 2), 'received');
        markSubActive('subFunkoActualizado');
      });

      connection.on('FunkoActualizadoPatch', (data) => {
        addMessage('🩹 FUNKO_PATCH', JSON.stringify(data, null, 2), 'received');
        markSubActive('subFunkoPatch');
      });

      connection.on('FunkoEliminado', (data) => {
        addMessage('❌ FUNKO_ELIMINADO', JSON.stringify(data, null, 2), 'received');
        markSubActive('subFunkoEliminado');
      });

      // --- GESTIÓN DE ESTADO DE CONEXIÓN ---

      connection.onclose(() => {
        status.className = 'status-item status-disconnected';
        status.textContent = '📡 Desconectado';
        btnConnect.disabled = false;
        btnDisconnect.disabled = true;
        resetSubs();
        addMessage('SISTEMA', '🔌 SignalR desconectado 💕', 'info');
      });

      connection.onreconnecting(() => {
        status.className = 'status-item status-loading';
        status.textContent = '🔄 Reconectando...';
      });

      connection.onreconnected(() => {
        status.className = 'status-item status-connected';
        status.textContent = '✅ Conectado';
        addMessage('SISTEMA', '🔄 Reconectado a SignalR! 💖', 'success');
        // Importante: Volver a unirse al grupo tras reconexión
        connection.invoke("JoinGroup", "admins");
      });

      // --- INICIAR CONEXIÓN ---

      await connection.start();

      status.className = 'status-item status-connected';
      status.textContent = '✅ Conectado';
      btnConnect.disabled = true;
      btnDisconnect.disabled = false;
      reconnectAttempts = 0;
      addMessage('SISTEMA', '🎉 Conexión establecida! 💖', 'success');

      // !!! PASO CRUCIAL PARA TU API !!!
      // Unirse al grupo "admins" porque FunkoService envía solo a ese grupo
      try {
        await connection.invoke("JoinGroup", "admins");
        addMessage('SISTEMA', '🔐 Unido al grupo "admins" correctamente.', 'success');
      } catch (err) {
        addMessage('ERROR', 'No se pudo unir al grupo admins: ' + err, 'error');
      }

    } catch (error) {
      status.className = 'status-item status-disconnected';
      status.textContent = '📡 Error';
      btnConnect.disabled = false;
      addMessage('SISTEMA', '❌ Error al conectar: ' + error.message, 'error');
      console.error(error);
    }
  }

  function disconnectSignalR() {
    if (connection) {
      connection.stop();
      connection = null;
    }
  }

  function markSubActive(id) {
    const el = document.getElementById(id);
    if(el) {
      el.classList.add('active');
      setTimeout(() => el.classList.remove('active'), 2000);
    }
  }

  function resetSubs() {
    document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active'));
  }

  function addMessage(prefix, content, type) {
    const container = document.getElementById('receivedMessages');
    const timestamp = new Date().toLocaleTimeString();

    const messageDiv = document.createElement('div');
    messageDiv.style.marginBottom = '10px';
    messageDiv.style.padding = '10px';
    messageDiv.style.borderRadius = '10px';

    if (type === 'received') {
      messageDiv.style.background = 'rgba(152, 251, 152, 0.3)';
      messageDiv.style.borderLeft = '4px solid #32CD32';
    } else if (type === 'error') {
      messageDiv.style.background = 'rgba(255, 182, 193, 0.5)';
      messageDiv.style.borderLeft = '4px solid #FF1493';
    } else {
      messageDiv.style.background = 'rgba(255, 215, 0, 0.3)';
      messageDiv.style.borderLeft = '4px solid #FFD700';
    }

    messageDiv.innerHTML = `<strong>${prefix}</strong> [${timestamp}]:<br>${content.replace(/\n/g, '<br>')}`;
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
  }

  // Inicializar URL por defecto correcta para tu API
  document.getElementById('hubUrl').value = 'http://localhost:5180/hubs/funkos';
</script>
</body>
</html>